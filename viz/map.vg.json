{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 800,
  "height": 500,
  "autosize": "fit",
  "background": "#a2c7e4",
  "signals": [
    { "name": "tx", "update": "width / 2" },
    { "name": "ty", "update": "height / 2" },
    {
      "name": "scale",
      "value": 160000,
      "on": [
        {
          "events": { "type": "wheel", "consume": true },
          "update": "max(scale * pow(1.0005, -event.deltaY * pow(16, event.deltaMode)), 40000)"
        }
      ]
    },
    {
      "name": "angles",
      "value": [0, 0],
      "on": [{ "events": "pointerdown", "update": "[rotateX, centerY]" }]
    },
    {
      "name": "cloned",
      "value": null,
      "on": [{ "events": "pointerdown", "update": "copy('projection')" }]
    },
    {
      "name": "start",
      "value": null,
      "on": [{ "events": "pointerdown", "update": "invert(cloned, xy())" }]
    },
    {
      "name": "drag",
      "value": null,
      "on": [
        {
          "events": "[pointerdown, window:pointerup] > window:pointermove",
          "update": "invert(cloned, xy())"
        }
      ]
    },
    {
      "name": "delta",
      "value": null,
      "on": [
        {
          "events": { "signal": "drag" },
          "update": "[drag[0] - start[0], start[1] - drag[1]]"
        }
      ]
    },
    {
      "name": "rotateX",
      "value": 0,
      "on": [
        { "events": { "signal": "delta" }, "update": "angles[0] + delta[0]" }
      ]
    },
    {
      "name": "centerY",
      "value": 40.7,
      "on": [
        {
          "events": { "signal": "delta" },
          "update": "clamp(angles[1] + delta[1], -60, 60)"
        }
      ]
    }
  ],
  "projections": [
    {
      "name": "projection",
      "type": "mercator",
      "rotate": [{ "signal": "rotateX" }, 0, 0],
      "scale": { "signal": "scale" },
      "center": [-73.94, { "signal": "centerY" }],
      "translate": [{ "signal": "tx" }, { "signal": "ty" }]
    }
  ],
  "data": [
    {
      "name": "boroughs",
      "url": "https://gist.githubusercontent.com/traviskaufman/e33677d3dd62d16f9f4c8c08dd290f20/raw/b50e63bc59ea20882651382acdda900d443913d9/nycboroughs.geo.json",
      "format": { "type": "json", "property": "features" }
    },
    {
      "name": "subway_lines",
      "url": "https://gist.githubusercontent.com/traviskaufman/e33677d3dd62d16f9f4c8c08dd290f20/raw/29ce804527a0bacbe67099014e066392b39bb077/subways.geo.json",
      "format": { "type": "json", "property": "features" }
    },
    {
      "name": "art_ridership",
      "url": "https://gist.githubusercontent.com/traviskaufman/e33677d3dd62d16f9f4c8c08dd290f20/raw/d057f93b6c7f5191b6cd77ebb009a4de28883fc4/art_ridership_v2.csv",
      "format": {
        "type": "csv",
        "parse": {
          "date": "date:%Y-%m-%d",
          "latitude": "number",
          "longitude": "number",
          "num_art_pieces": "number",
          "ridership": "number"
        }
      },
      "transform": [
        { "type": "filter", "expr": "year(datum.date) == 2024" },
        {
          "type": "geopoint",
          "projection": "projection",
          "fields": ["longitude", "latitude"]
        },
        {
          "type": "joinaggregate",
          "fields": ["ridership"],
          "ops": ["sum"],
          "as": ["ridership_total"],
          "groupby": ["stop_name", "line", "borough"]
        }
      ]
    }
  ],
  "scales": [
    {
      "name": "Subway Colors",
      "type": "ordinal",
      "domain": [
        "G",
        "M",
        "S",
        "A",
        "B-D",
        "B-D-F-M",
        "R",
        "N-Q-R",
        "N-Q",
        "N-R",
        "F",
        "F-M",
        "E",
        "7",
        "J-Z",
        "L",
        "A-C",
        "D",
        "1-2-3",
        "B",
        "Q",
        "4-5-6",
        "N",
        "1",
        "N-W",
        "2-3",
        "2",
        "4-5",
        "5",
        "4",
        "3",
        "A-C-E",
        "N-Q-R-W",
        "N-R-W",
        "6",
        "R-W"
      ],
      "range": [
        "#6CBE45",
        "#FF6319",
        "#808183",
        "#0039A6",
        "#FF6319",
        "#FF6319",
        "#FCCC0A",
        "#FCCC0A",
        "#FCCC0A",
        "#FCCC0A",
        "#FF6319",
        "#FF6319",
        "#0039A6",
        "#B933AD",
        "#996633",
        "#A7A9AC",
        "#0039A6",
        "#FF6319",
        "#EE352E",
        "#FF6319",
        "#FCCC0A",
        "#00933C",
        "#FCCC0A",
        "#EE352E",
        "#FCCC0A",
        "#EE352E",
        "#EE352E",
        "#00933C",
        "#00933C",
        "#00933C",
        "#EE352E",
        "#0039A6",
        "#FCCC0A",
        "#FCCC0A",
        "#00933C",
        "#FCCC0A"
      ]
    },
    {
      "name": "ridership_size",
      "type": "linear",
      "domain": { "data": "art_ridership", "field": "ridership_total" },
      "range": [25, 500]
    },
    {
      "name": "art_presence_color",
      "type": "threshold",
      "domain": [1, 2],
      "range": { "scheme": "redblue" }
    }
  ],
  "marks": [
    {
      "name": "Boroughs",
      "type": "shape",
      "from": { "data": "boroughs" },
      "encode": {
        "enter": {
          "fill": { "value": "#fbefe2" },
          "stroke": { "value": "#aaa" }
        }
      },
      "transform": [{ "type": "geoshape", "projection": "projection" }]
    },
    {
      "name": "Subway Lines",
      "type": "shape",
      "from": { "data": "subway_lines" },
      "encode": {
        "enter": {
          "fill": { "value": null },
          "stroke": { "scale": "Subway Colors", "field": "properties.name" }
        }
      },
      "transform": [{ "type": "geoshape", "projection": "projection" }]
    },
    {
      "name": "Art Ridership Symbols",
      "type": "symbol",
      "from": { "data": "art_ridership" },
      "encode": {
        "enter": {
          "stroke": { "value": "#666" },
          "strokeWidth": { "value": 1 },
          "tooltip": {
            "signal": "{'title': datum.stop_name, 'Lines': datum.line, 'Ridership Total (2024)': format(datum.ridership_total, ','), 'Number of Artworks': datum.num_art_pieces}"
          },
          "fill": {
            "field": "num_art_pieces",
            "scale": "art_presence_color"
          },
          "size": {
            "field": "ridership_total",
            "scale": "ridership_size"
          }
        },
        "update": { "x": { "field": "x" }, "y": { "field": "y" } }
      }
    }
  ]
}
